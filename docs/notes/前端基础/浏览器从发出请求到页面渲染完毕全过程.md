# 网络请求全过程

## 1、应用层进行 URL 解析、DNS 解析

- `URL`解析得到：协议（http/https）、域名、数据文件路径、查询参数，生成请求报文

- 域名解析得到 IP：浏览器根据域名从`缓存 -> 操作系统缓存 -> 本地DNS服务器 -> 根服务器`中查找 IP 地址

## 2、运输层进行三次握手建立 TCP 连接，通过网络层发送 IP 包至目标服务器

- 添加 TCP 头部：`三次握手` 建立 TCP 连接，对每个数据块添加 TCP 头部

  - 客户端发送 `SYN 包`（同步序列编号）
  - 服务器回应 `SYN-ACK 包`（同步-确认）
  - 客户端再发送 `ACK 包（确认）`，连接建立

- 添加 IP 头部(实现远程定位)：通过路由表得到`源IP地址`，`源IP地址 + 目的IP地址`等信息组成 IP 头部，添加到数据报文中 -> `IP报文`

- 添加 MAC 头部（实现以太网传输）：MAC 包头包含`发送方MAC地址 + 接收方MAC地址`，`发送方MAC地址`是在网卡生产时写入到`ROM`中的,`接收方MAC地址`需要通过`ARP`协议在以太网中以广播的形式获取，最后形成 MAC 包头拼接到数据报文中

- `网卡`将`数字信号`转为`电信号`发送给交换机，`交换机`再转发给`路由器`，然后在路由器中层层跳跃最终到达`目标服务器`

## 3、HTTPS 握手（应用层+运输层）

- 浏览器发送服务器 Hello 消息，开始 TLS 握手
- 服务器响应客户端 Hello 消息，发送证书，协商加密算法
- 浏览器验证证书，生成对称加密密钥，双方完成握手

## 4、发送 HTTP 请求（应用层+运输层）

- 浏览器构建 http 请求报文，包括：请求行、请求头、请求体
- 将 http 请求封装在 TCP 数据包中通过运输层发送至服务器

## 5、服务器处理请求并响应（应用层+运输层）

- 服务器接收请求并处理生成 HTTP 响应，包括：状态行、响应头、响应体
- 将响应封装在 TCP 数据包中通过运输层发送回浏览器

- 服务器响应请求：
  - 目标服务器`检查数据包的目的MAC地址`与自己的 MAC 地址是否相同，不同则直接丢弃
  - `检查IP头部`，根据 IP 头部中的协议项知道上层是否是 TCP 协议
  - `检查TCP头部`，根据 TCP 头部中的端口号找到响应的进程
  - 根据`请求数据文件路径`找到文件并封装在 HTTP 响应报文中发送给客户端

## 6、浏览器接收响应并渲染页面（应用层）

- 浏览器解析 HTTP 响应，处理 HTML、CSS、JavaScript 等资源
  - 浏览器在解析 HTML 时，发现额外资源（.png、css...）则会发送额外的 http 请求获取这些资源
- 构建 DOM 树、CSSOM 树，执行 JS，生成渲染树
- 布局并绘制页面内容到屏幕上

## n、TCP 四次挥手，断开连接【在 HTTP/2 和 HTTP/3 协议中，数据传输和页面渲染可并行进行】

- `客户端发送一个FIN报文`‌，表明客户端已经完成了数据发送，准备关闭连接
- `‌服务器收到FIN报文后，发送一个ACK报文‌`，确认收到客户端的关闭请求
- ‌`服务器完成数据发送后，再发送一个FIN报文‌`，告诉客户端它也已经完成了数据发送
- `‌客户端收到这个FIN报文后，发送一个ACK报文`‌，确认收到服务器的关闭请求，此时连接正式关闭
